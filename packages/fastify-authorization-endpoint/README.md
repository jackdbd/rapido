# @jackdbd/fastify-authorization-endpoint

[![npm version](https://badge.fury.io/js/@jackdbd%2Ffastify-authorization-endpoint.svg)](https://badge.fury.io/js/@jackdbd%2Ffastify-authorization-endpoint)
[![install size](https://packagephobia.com/badge?p=@jackdbd/fastify-authorization-endpoint)](https://packagephobia.com/result?p=@jackdbd/fastify-authorization-endpoint)
[![CodeCov badge](https://codecov.io/gh/jackdbd/rapido/graph/badge.svg?token=BpFF8tmBYS)](https://app.codecov.io/gh/jackdbd/rapido?flags%5B0%5D=fastify-authorization-endpoint)
[![Socket Badge](https://socket.dev/api/badge/npm/package/@jackdbd/fastify-authorization-endpoint)](https://socket.dev/npm/package/@jackdbd/fastify-authorization-endpoint)

Fastify plugin that adds an [IndieAuth Authorization Endpoint](https://indieauth.spec.indieweb.org/#authorization-endpoint) to a Fastify server.

An IndieAuth Authorization Endpoint is responsible for obtaining authentication or authorization consent from the end user and generating and verifying authorization codes.

- [Installation](#installation)
- [Authorization Endpoint Options](#authorization-endpoint-options)
  - [components: object](#components-object)
  - [templates\[\]: array](#templates-array)
- [Obtaining an authorization code](#obtaining-an-authorization-code)
  - [Authorization Request Querystring](#authorization-request-querystring)
- [Verifying the authorization code](#verifying-the-authorization-code)
  - [Access Token Request Body](#access-token-request-body)
- [Dependencies](#dependencies)
- [Authorization codes](#authorization-codes)
- [References](#references)
- [License](#license)

## Installation

```sh
npm install @jackdbd/fastify-authorization-endpoint
```

## Authorization Endpoint Options

Options for the Fastify authorization-endpoint plugin

**Properties**

|Name|Type|Description|Required|
|----|----|-----------|--------|
|**ajv**||Instance of Ajv<br/>|no|
|**authorizationCodeExpiration**|`string`|Default: `"10 minutes"`<br/>Minimal Length: `1`<br/>|no|
|[**components**](#components)|`object`|Filepaths to WebC components<br/>|no|
|**redirectPathOnSubmit**|`string`|Default: `"/consent"`<br/>Minimal Length: `1`<br/>|no|
|**includeErrorDescription**|`boolean`|Whether to include an `error_description` property in all error responses. This is meant to assist the client developer in understanding the error. This is NOT meant to be shown to the end user.<br/>Default: `false`<br/>|no|
|**issuer**|`string`|The authorization server's issuer identifier. It's a URL that uses the "https" scheme and has no query or fragment components. It MUST also be a prefix of the indieauth-metadata URL.<br/>Format: `"uri"`<br/>|no|
|**logPrefix**|`string`|Default: `"[authorization-endpoint] "`<br/>|no|
|**onAuthorizationCodeVerified**|`Function`|Handler that runs after an authorization code has been verified. You should use this handler to inform your storage backend that the authorization code has been used.<br/>|yes|
|**onUserApprovedRequest**|`Function`|Handler executed after the user approves the authorization request on the consent screen. You should use it to persist the authorization code generated by the authorization code generated by the authorization endpoint into your storage backend.<br/>|yes|
|**reportAllAjvErrors**<br/>(report all AJV errors)|`boolean`|Whether to report all AJV validation errors.<br/>Default: `false`<br/>|no|
|**retrieveAuthorizationCode**|`Function`|Retrieves an authorization code from a storage backend.<br/>|yes|
|[**templates**](#templates)|`string[]`|Filepaths to WebC templates<br/>|no|

**Example**

```json
{
    "authorizationCodeExpiration": "10 minutes",
    "components": {},
    "redirectPathOnSubmit": "/consent",
    "includeErrorDescription": false,
    "logPrefix": "[authorization-endpoint] ",
    "reportAllAjvErrors": false
}
```

<a name="components"></a>
### components: object

Filepaths to WebC components

**Properties**

|Name|Type|Description|Required|
|----|----|-----------|--------|
|**consent\-form**|`string`|Minimal Length: `1`<br/>||
|**scope\-list**|`string`|Minimal Length: `1`<br/>||
|**the\-footer**|`string`|Minimal Length: `1`<br/>||
|**the\-header**|`string`|Minimal Length: `1`<br/>||

<a name="templates"></a>
### templates\[\]: array

Filepaths to WebC templates

**Items**

**Item Type:** `string`  
**Item Minimal Length:** `1`  
**Minimum Items:** 1  

## Obtaining an authorization code

When the end user accesses the authorization endpoint, they are presented with a [consent screen](https://indieweb.org/consent_screen). The details displayed on the consent screen are populated based on the information provided in the query string of the request.

### Authorization Request Querystring

**Properties**

|Name|Type|Description|Required|
|----|----|-----------|--------|
|**client\_id**|`string`|The ID of the application that asks for authorization. An IndieAuth client ID is a URL.<br/>Format: `"uri"`<br/>|yes|
|**code\_challenge**<br/>(PKCE code challenge)|`string`|The PKCE code challenge. See [Client Creates the Code Challenge](https://datatracker.ietf.org/doc/html/rfc7636#section-4.2).<br/>Minimal Length: `43`<br/>Maximal Length: `128`<br/>|yes|
|**code\_challenge\_method**<br/>(PKCE code challenge method)||The hashing method used to calculate the code challenge in the PKCE OAuth 2.0 flow. See [Client Creates the Code Challenge](https://datatracker.ietf.org/doc/html/rfc7636#section-4.2).<br/>|yes|
|**me**|||yes|
|**redirect\_uri**|`string`|Holds a URL. A successful response from this endpoint results in a redirect to this URL.<br/>Format: `"uri"`<br/>|yes|
|**response\_type**|`string`|Default: `"code"`<br/>Constant Value: `"code"`<br/>|yes|
|**scope**<br/>(OAuth 2\.0 scope \(scopes\) claim)|`string`|Scope values. See [RFC8693 scope claim](https://www.rfc-editor.org/rfc/rfc8693.html#name-scope-scopes-claim)<br/>Minimal Length: `1`<br/>|no|
|**state**<br/>(OAuth 2\.0 state parameter \(CSRF token\))|`string`|An opaque value used by the client to maintain state between the request and callback. The parameter SHOULD be used for preventing cross-site request forgery. See [OAuth 2.0 Authorization Request](https://www.rfc-editor.org/rfc/rfc6749#section-4.1.1).<br/>Minimal Length: `1`<br/>|yes|

**Example**

```json
{
    "response_type": "code"
}
```

## Verifying the authorization code

To verify that the authorization code is valid, the token endpoint of the authorization server makes a POST request to the authorization endpoint.

### Access Token Request Body

**Properties**

|Name|Type|Description|Required|
|----|----|-----------|--------|
|**client\_id**|`string`|The ID of the application that asks for authorization. An IndieAuth client ID is a URL.<br/>Format: `"uri"`<br/>|yes|
|**code**<br/>(Authorization code)|`string`|Authorization code issued by the authorization endpoint of the IndieAuth server. It should be a single-use, unguessable, random string.<br/>Minimal Length: `32`<br/>Maximal Length: `1000`<br/>|yes|
|**code\_verifier**|`string`|PKCE code verifier. A high-entropy cryptographic random string. See [Client Creates a Code Verifier](https://datatracker.ietf.org/doc/html/rfc7636#section-4.1).<br/>Minimal Length: `43`<br/>Maximal Length: `128`<br/>|yes|
|**grant\_type**|`string`|Constant Value: `"authorization_code"`<br/>|yes|
|**redirect\_uri**|`string`|Holds a URL. A successful response from this endpoint results in a redirect to this URL.<br/>Format: `"uri"`<br/>|yes|

## Dependencies

| Package | Version |
|---|---|
| [@fastify/formbody](https://www.npmjs.com/package/@fastify/formbody) | `^8.0.2` |
| [@fastify/response-validation](https://www.npmjs.com/package/@fastify/response-validation) | `^3.0.3` |
| [@hapi/hoek](https://www.npmjs.com/package/@hapi/hoek) | `^11.0.7` |
| [@jackdbd/canonical-url](https://www.npmjs.com/package/@jackdbd/canonical-url) | `^0.2.0-canary.8` |
| [@jackdbd/fastify-webc](https://www.npmjs.com/package/@jackdbd/fastify-webc) | `*` |
| [@jackdbd/indieauth](https://www.npmjs.com/package/@jackdbd/indieauth) | `0.2.0-canary.11` |
| [@jackdbd/oauth2-error-responses](https://www.npmjs.com/package/@jackdbd/oauth2-error-responses) | `^0.2.0-canary.8` |
| [@jackdbd/pkce](https://www.npmjs.com/package/@jackdbd/pkce) | `^0.2.0-canary.7` |
| [@jackdbd/schema-validators](https://www.npmjs.com/package/@jackdbd/schema-validators) | `^0.2.0-canary.11` |
| [@sinclair/typebox](https://www.npmjs.com/package/@sinclair/typebox) | `^0.34.14` |
| [ajv](https://www.npmjs.com/package/ajv) | `^8.17.1` |
| [ajv-formats](https://www.npmjs.com/package/ajv-formats) | `^3.0.1` |
| [dayjs](https://www.npmjs.com/package/dayjs) | `^1.11.13` |
| [dayjs-plugin-utc](https://www.npmjs.com/package/dayjs-plugin-utc) | `^0.1.2` |
| [fastify-plugin](https://www.npmjs.com/package/fastify-plugin) | `^5.0.1` |
| [ms](https://www.npmjs.com/package/ms) | `3.0.0-canary.1` |

> [!WARNING]
> This package defines 1 peer dependency.

| Peer | Version range |
|---|---|
| `fastify` | `>=5.0.0` |

## Authorization codes

The [authorization codes](https://indieauth.spec.indieweb.org/#authorization-request) issued by the authorization endpoint implemented by this plugin are [Nano IDs](https://zelark.github.io/nano-id-cc/) generated with [nanoid](https://github.com/ai/nanoid).

## References

- [Redeeming the Authorization Code](https://indieauth.spec.indieweb.org/#redeeming-the-authorization-code)
- [Authorization Code Grant - The OAuth 2.0 Authorization Framework (RFC 6749)](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1)
- [Authorization Endpoint - The OAuth 2.0 Authorization Framework (RFC 6749)](https://datatracker.ietf.org/doc/html/rfc6749#section-3.1)
- [Authorization Request - The OAuth 2.0 Authorization Framework (RFC 6749)](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.1)
- [Authorization Response - The OAuth 2.0 Authorization Framework (RFC 6749)](https://datatracker.ietf.org/doc/html/rfc6749#section-4.1.2)
- [Authorization Request - IndieAuth](https://indieauth.spec.indieweb.org/#authorization-request)
- [Authorization Response - IndieAuth](https://indieauth.spec.indieweb.org/#x5-2-1-authorization-response)
- [IndieAuth Rocks! (validator for testing IndieAuth client and server implementations)](https://indieauth.rocks/)
- [IndieAuth scopes](https://indieweb.org/scope#IndieAuth_Scopes): `email`, `profile`
- [Micropub scopes](https://indieweb.org/scope#Microsub_Scopes): `create`, `update`, `delete`, `undelete`, `draft`, `media`

## License

&copy; 2024 - 2025 [Giacomo Debidda](https://www.giacomodebidda.com/) // [MIT License](https://spdx.org/licenses/MIT.html)
